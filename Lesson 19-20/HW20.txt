
--1.	Покажите всех менеджеров, которые имеют в подчинении больше 6-ти сотрудников.

Select e.First_Name , e.Last_Name, cnt
FROM Employees e 
JOIN (
	Select manager_id , Count(EmploeID) as cnt
	FROM Employees e
	GROUP BY manager_id
	HAVING Count(EmploeID)>6 
	) x ON x.manager_id=e.Employee_id
Where x.manager_id IS NOT NULL


--2.	Вывести min и max зарплату с вычетом commission_pct для каждого департамента. 
	--(commission_pct на базе указывается в процентах). 

SELECT d.Departmen_name 
, Max(e.Salary*(1-e.commission_pcn/100) AS Max_SalCom
, MIN(e.Salary*(1-e.commission_pcn/100) AS Min_SalCom
FROM  Employees e 
JOIN Departmrnts d ON d.department_id=e.department_id
GROUP BY d.Departmen_name

	
--3.	Вывести только регион, где работают больше всего людей.


Select TOP 1 with TIES x.Region_name
FROM (
	SELECT r.Region_name,  COUNT (e.Emploe_ID) AS cnt
	FROM Employees e
	JOIN Departmrnts d ON d.department_id=e.department_id
	JOIN Location l ON l.Locationt_id=d.Location_id
	JOIN Countries c ON c.country_id= l.country_id
	JOIN Regions r ON r.Region_id=c.Region_id
	GROUP BY r.Region_name
	ORDER BY cnt DESC ) x


--4.	Найдите разницу в процентах между средней зп по каждому департаменту от общей средней (по всем департаментам).

Select d.Department_name
	,(( AVG(e.salary) over ())/(AVG(e.salary) over (partition by e.departmrnt_id))-1)*100 AS deltaPC 
FROM Employees e
JOIN Departmrnts d ON d.department_id=e.department_id
GROUP BY d.Department_name


--5.	Найдите людей, кто проработал больше, чем 10 лет в одном департаменте. 

SELECT * 
FROM (
	Select e.First_Name, e.LAST_NAME,
		CASE 
		WHEN h.End_Date IS NULL THEN DATEDIFF (year ,GETDATE(),h.Start_DATE)
		WHEN h.End_Date IS NOT  NULL THEN DATEDIFF (year ,h.END_DATE ,h.Start_DATE)
		else 0
		end AS STAZH
	FROM JOB_Histopy h
	JOIN Employees e   ON e.Employee_id=h.Employee_id
	GROUP BY h.Employee_id, h.department_id
	) y 
WHERE STAZH >10


--6.	Найдите людей, кто занимает 5-10 место по размеру зарплаты. 

Select e.First_Name, e.LAST_NAME, x.Plase
FROM Employees e
JOIN (
	SELECT DISTINCT e.salary
	, ROW_NUMBER () OVER ( ORDER BY e.salary DESC) AS Plase
	FROM Employees e
	GROUP BY e.salary
	) x ON x.salary=e.salary AND x.Plase between 5 AND 10

